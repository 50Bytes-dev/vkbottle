# Framework API

Здесь будут описаны основные функции фреймворка и основного класса

# Хендлинг сообщений

Все сообщения валидируются несколькими типами хендлеров

## Обычная валидация

Обычная валидация, валидация со старта, валидация регексами хранятся и обрабатываются с помощью vbml

```python
@bot.on.message(text="*")
@bot.on.chat_message(text="*")
# * - VBML Pattern
```

При интерпретации хендлеров они записываются в немутабельный словарь с паттернами vbml в качестве ключей. Время аптайма бота прямо пропорционально зависит количеству интерпретируемых хендлеров

## Валидация со старта

Валидация со старта хранится и обрабатывается так же как и обычная валидация, она отличается от обычной только тем, что pattern регекс обертки не имеет ограничителей в конце

```python
@bot.on.message.startswith(text="*")
@bot.on.chat_message.startswith(text="*")
# * - VBML Pattern
```

## Payload-валидация

Payload-валидация обрабатывает только сообщения с полем payload. Хендлер может принимать строку или словарь для валидации. В объекте сообщения несмотря на реагируемый хендлер в качестве payload возвращается строка

### Строгий payload

```python
@bot.on.message.payload({"command": "start"})
@bot.on.chat_message.payload({"command": "start"})
# Хендлер вызывается при получении сообщения с payload равным '{"command":"start"}'
```

### Нестрогий payload

Вызывается при случае, когда payload сообщения является словарем и валидируемый словарь содержит все элементы словаря хендлера

```python
@bot.on.message.payload.contains({"a": "b"})
@bot.on.chat_message.payload.contains({"a": "b"})
# Хендлер будет возбужден при payload содержащем состояние "a": "b", например '{"a":"b", "c":"d"}'
```

## Регекс валидация

```python
@bot.on.message.regex(r"*")
@bot.on.message.regex(r"*")
# * - regex
```

## Message Undefined

Хендлер возбуждается (при условии существования) при любом не свалидированном сообщении:

```python
@bot.on.message()
@bot.on.chat_message()
```

## add_handler

Создает хендлер без декоратора. Принимает два обязательных аргумента:

**text** - vbml.Pattern или строка, нужно для создания паттерна хендлера

**func** - асинхронная функция обработки

## Опции хендлинга

### change_prefix_for_all

Позволяет изменить **односимвольные** префиксы для хендлеров. Принимает один аргумент - список

```python
bot.on.change_prefix_for_all(["!", "/"])
```

Изменит возможные префиксы валидаторов для всех хендлеров сообщений с аргументом command равном True

### dispatch (async)

Дословно - распаковывает хендлеры message_both в message и chat_message. При добавлении хендлеров через add_handler в message_both должно быть обязательно выполнено

По умолчанию распаковка происходит при первой эмуляции

```python
asyncio.create_task(bot.on.dispatch())
await bot.on.dispatch()
```

## Прямые хендлеры

### pre_process

Всегда вызывается до поиска реакции на хендлеры личного и сообщения из беседы. Не используется return-handler синтаксис, то есть, например для бранчей, следует использовать рекомендованный альтернативный синтаксис

```python
@bot.on.pre_process()
```

### chat_mention, chat_invite

**chat_mention** - вызываются при единичном упоминании бота в чате

**chat_invite** - вызывается при приглашении бота в беседу

### chat_action

Принимает два аргумента:

**type** - строка, принимает название action для обработки

**rules** - словарь, содержит элементы, которые должны быть идентичны в проверяемом action объекте

# Основные функции Bot

## Обработка

### run_polling

Запускает лонгполл

### run (async)

(PARAM) - skip_updates
Запускает лонгполл, используется для запуска в TaskManager

### emulate (async)

**event** - словарь, содержащий событие от сервера VK

**confirmation_token** - код конфирмации, нужный для подтверждения CallBack

Эмулирует событие, используется для внутренней, ложной и эмуляции событий в callback

## Дополнительные

### set_debug

Обновляет логгер бота на новые параметры. Принимаемые аргументы:

**debug** - boolean, режим логирования

****params** - аргументы логгера для инициирования

### copy

Создает копию объекта бота, которая отличается от родителя только тем, что копия обновлена функцией **loop_update**

### empty_copy

Создает копию объекта бота, которая лишена всех хендлеров, не изменяет 

### loop_update

Обновляет loop модуля asyncio

### get_updates (async)

Отвечает непрочитанным сообщениям, если они накоплены

# BotStatus

# status

### change_handler_return_context

Изменяет основные настройки для **_return_handler_processor**. По умолчанию при возвращении строки из валидируемой функции хендлера отправляется простое сообщение, указанная функция помогает добавить постоянные аргументы, например attachment

```python
bot.status.change_handler_return_context(attachment="wall-1_1")
```

### readable

Возвращает информацию о том, запущен ли лонгполл и распакованы ли хендлеры


