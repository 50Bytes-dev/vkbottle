# Framework API

Здесь будут описаны основные функции фреймворка и основного класса  
** - text может принимать как строку, так и список строк, так и паттерн вбмл, так и список из паттернов вбмл, так и все в перемешку

# Хендлинг сообщений

Все сообщения валидируются несколькими типами хендлеров

## Обычная валидация

Обычная валидация, валидация со старта, валидация регексами хранятся и обрабатываются с помощью vbml  
text может принимать как строку, так и список строк, так и паттерн вбмл, так и список из паттернов вбмл, так и все в перемешку
(**)

```python
@bot.on.message(text="*")
@bot.on.chat_message(text="*")
# * - VBML Pattern
```

При интерпретации хендлеров они записываются в немутабельный словарь с паттернами vbml в качестве ключей. Время аптайма бота прямо пропорционально зависит количеству интерпретируемых хендлеров

## Payload-валидация

Payload-валидация обрабатывает только сообщения с полем payload. Хендлер может принимать строку или словарь для валидации. В объекте сообщения несмотря на реагируемый хендлер в качестве payload возвращается строка

### Строгий payload

```python
@bot.on.message.payload({"command": "start"})
@bot.on.chat_message.payload({"command": "start"})
# Хендлер вызывается при получении сообщения с payload равным '{"command":"start"}'
```

### Нестрогий payload

Вызывается при случае, когда payload сообщения является словарем и валидируемый словарь содержит все элементы словаря хендлера

```python
@bot.on.message.payload.contains({"a": "b"})
@bot.on.chat_message.payload.contains({"a": "b"})
# Хендлер будет возбужден при payload содержащем состояние "a": "b", например '{"a":"b", "c":"d"}'
```

## Message Undefined

Хендлер возбуждается (при условии существования) при любом не свалидированном сообщении:

```python
@bot.on.message()
@bot.on.chat_message()
```

## add_handler

Создает хендлер без декоратора. Принимает два обязательных аргумента:

**text** (**)

**func** - асинхронная функция обработки

## Опции хендлинга

Изменит возможные префиксы валидаторов для всех хендлеров сообщений с аргументом command равном True

### dispatch (async)

Дословно - распаковывает хендлеры message_both в message и chat_message. При добавлении хендлеров через add_handler в message_both должно быть обязательно выполнено

По умолчанию распаковка происходит при первой эмуляции

```python
asyncio.create_task(bot.on.dispatch())
await bot.on.dispatch()
```

## Прямые хендлеры

### pre_process

Добавляет middleware. Может быть использован только один раз, поэтому не рекомендуется к использованию

```python
@bot.on.pre_process()
```

### chat_mention, chat_invite

**chat_mention** - вызываются при единичном упоминании бота в чате

**chat_invite** - вызывается при приглашении бота в беседу

### chat_action

Принимает два аргумента:

**type** - строка, принимает название action для обработки

**rules** - словарь, содержит элементы, которые должны быть идентичны в проверяемом action объекте

# Основные функции Bot

## Обработка

### run_polling

Запускает лонгполл

### run (async)

(PARAM) - skip_updates
Запускает лонгполл, используется для запуска в TaskManager

### emulate (async)

**event** - словарь, содержащий событие от сервера VK

**confirmation_token** - код конфирмации, нужный для подтверждения CallBack

Эмулирует событие, используется для внутренней, ложной и эмуляции событий в callback

## Дополнительные

### set_debug

Обновляет логгер бота на новые параметры. Принимаемые аргументы:

**debug** - boolean, режим логирования

****params** - аргументы логгера для инициирования

### copy

Создает копию объекта бота, которая отличается от родителя только тем, что копия обновлена функцией **loop_update**

### empty_copy

Создает копию объекта бота, которая лишена всех хендлеров, не изменяет 

### loop_update

Обновляет loop модуля asyncio

### get_updates (async)

Отвечает непрочитанным сообщениям, если они накоплены

# BotStatus

# status

### change_handler_return_context

Изменяет основные настройки для **_return_handler_processor**. По умолчанию при возвращении строки из валидируемой функции хендлера отправляется простое сообщение, указанная функция помогает добавить постоянные аргументы, например attachment

```python
bot.status.change_handler_return_context(attachment="wall-1_1")
```

### readable

Возвращает информацию о том, запущен ли лонгполл и распакованы ли хендлеры


# Нестандартные условия работы и проблемы

## C++ Build tools

```text
Microsoft Visual C++ 14.0 is required. Get it with "Build Tools for Visual Studio"
```

Решение на эту проблему можно найти в issue [#47](https://github.com/timoniq/vkbottle/issues/47)

## sem_open implementation

```text
ImportError: This platform lacks a functioning sem_open implementation, therefore,
the required synchronization primitives needed will not function, see issue 3770
```

Проблема возникает при попытке использования `VKBottle` через такие вещи как Termux, Pydroid...  
Решение: пропишите флаг mobile при инициализации бота:

```python
bot = Bot(..., mobile=True)
```
